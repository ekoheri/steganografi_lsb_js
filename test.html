<html>
<body>
    <!-- https://medium.com/@6465660/javascript-magic-tricks-steganography-a0f9330e5e0d -->
    Input Gambar<input type='file' id='file' /><br>
    Gambar<canvas id='canvas' style='width: 300px;'></canvas><br>
    Pesan rahasia<textarea id='message'></textarea><br>
    <button id='encode' class='submit'>Encode</button><br>
    Gambar stego<img id='output' style='width: 300px;'><br>
    <button id='decode'>Decode</button><br>
    Hasil<div id='message_decoded'></div><br>
    <script>
        
        window.onload = function() {
            var input = document.getElementById('file');
            input.addEventListener('change', import_image);
            var encode_button = document.getElementById('encode');
            encode_button.addEventListener('click', encode);
            var decode_button = document.getElementById('decode');
            decode_button.addEventListener('click', decode);
        };
        //Setelah memilih file, tampilkan gambar di kanvas
        var import_image = function(e) {
            var reader = new FileReader();
            reader.onload = function(event) {
                var img = new Image();
                img.onload = function() {
                    var ctx = document.getElementById('canvas').getContext('2d');
                    ctx.canvas.width = img.width;
                    ctx.canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        //Steganografi dan menyimpan gambar
        var encode = function() {
            var message = document.getElementById('message').value;
            var output = document.getElementById('output');
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var pixel_count = ctx.canvas.width * ctx.canvas.height;
            if ((message.length + 1) * 16 > pixel_count * 4 * 0.75) {
                alert('Terlalu banyak konten, melebihi jumlah maksimal yang bisa ditulis');
                return;
            }
            //Fungsi inti: steganografi
            var img_data = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
            encode_message(img_data.data, message);
            ctx.putImageData(img_data, 0, 0);
            alert('Steganografi berhasil dan informasi telah disembunyikan di dalam gambar');
            output.src = canvas.toDataURL();
        };
        //读出隐写的信息
        var decode = function() {
            var ctx = document.getElementById('canvas').getContext('2d');
            var img_data = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
            //Fungsi inti: membaca informasi steganografi dari data gambar
            var message = decode_message(img_data.data);
            alert(message);
            document.getElementById('message_decoded').innerHTML = message;
        };
        //Ubah informasi yang dikodekan biner menjadi string
        var get_number_from_bits = function(bytes, history) {
            var number = 0;
            var pos = 0;
            while (pos < 16) {
                var loc = get_next_location(history, bytes.length);
                var bit = getBit(bytes[loc], 0);
                number = set_bit(number, pos, bit);
                pos++;
            }
            return number;
        };
        var get_next_location = function(history, total) {
            var pos = history.length;
            var loc = Math.abs(pos + 1) % total;
            while (true) {
                if (loc >= total) {
                    loc = 0;
                } else if (history.indexOf(loc) >= 0) {
                    loc++;
                } else if ((loc + 1) % 4 === 0) {
                    loc++;
                } else {
                    history.push(loc);
                    return loc;
                }
            }
        };
        var set_bit = function(number, location, bit) {
            return (number & ~(1 << location)) | (bit << location);
        };
        //将信息字符串转为二进制编码
        var get_message_bits = function(message) {
            var message_bits = [];
            for (var i = 0; i < message.length; i++) {
                var code = message.charCodeAt(i);
                message_bits = message_bits.concat(get_bits_from_number(code));
            }
            return message_bits;
        };
        var get_bits_from_number = function(number) {
            var bits = [];
            for (var i = 0; i < 16; i++) {
                bits.push(getBit(number, i));
            }
            return bits;
        };
        var getBit = function(number, location) {
            return ((number >> location) & 1);
        };
        //编码信息
        var encode_message = function(colors, message) {
            var message_bits = get_bits_from_number(message.length);
            message_bits = message_bits.concat(get_message_bits(message));
            var history = [];
            var pos = 0;
            while (pos < message_bits.length) {
                var loc = get_next_location(history, colors.length);
                colors[loc] = set_bit(colors[loc], 0, message_bits[pos]);
                while ((loc + 1) % 4 !== 0) {
                    loc++;
                }
                colors[loc] = 255;
                pos++;
            }
        };
        //解码信息
        var decode_message = function(colors) {
            var history = [];
            var message_size = get_number_from_bits(colors, history);
            if ((message_size + 1) * 16 > colors.length * 0.75) {
                return '';
            }
            var message = [];
            for(var i = 0; i < message_size; i++) {
                var code = get_number_from_bits(colors, history);
                message.push(String.fromCharCode(code));
            }
            return message.join('');
        };
    </script>
</body>
</html>